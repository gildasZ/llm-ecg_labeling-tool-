
<!-- partials/Bodypart/_bodypart_dropdown.html -->
<style>
    .model-selection {
        position: absolute; /* Positioned relative to .graph_display-area */
        top: 3px; /* Spacing from the top */
        left: 3px; /* Spacing from the left */
        display: flex; /* Aligns children in a row */
        align-items: center; /* Centers items vertically */
        height: 35px;
        background-color: #505050;
        box-sizing: border-box;
        border: 1px solid #067794;
        padding: 5px;
        cursor: default;
        border-radius: 10px; /* Rounded corners, adjust radius as needed */
        z-index: 10; /* Ensure it sits on top of other content */
    }

    /* .selection-field {
        align-items: center;
        background-color: #505050;
        color: white;
        box-sizing: border-box;
        border: 1px solid #067794;
        padding: 5px;
        cursor: default;
        width: 115px; 
        border-radius: 10px; 
        font-size: 14px; 
        font-weight: bold;
    } */

    .run-model-btn {
        position: relative; /* Needed to properly position the dropdown menu */
        margin-left: 5px; /* Space between the label and dropdown */
        /* border: 1px solid #067794; */
        border: 2px solid hsl(239, 66%, 24%); /* Thicker red border for more emphasis */
        background-color: #505050;
        color: rgb(249, 253, 14); /* white; */
        padding: 5px;
        cursor: pointer;
        width:75px; /* Example width, adjust as needed */
        border-radius: 10px; /* Rounded corners, adjust radius as needed */
        font-size: 16px;
        font-weight: bold;
        /* transition: transform 0.3s ease; Smooth transition for transform */
        transition: all 0.3s ease-in-out; /* Smooth transitions */
        outline: none; /* Remove default outline */
        overflow: hidden; /* For the glow effect */
        display: none;
    }

    /* Hover effect for the Delete header button */
    .run-model-btn:hover {
        color: #0c0000; /* White text */
        background-color: #47ff8d; /* Vibrant red (#ff6347) background */
        border-color: #ff6347; /* Matching border with background */
        box-shadow: 0px 0px 15px 5px rgba(175, 255, 71, 0.8); /* Glowing red shadow */
        transform: scale(1.1); /* Increase size on hover */
        font-weight: bold; /* Bold text on hover */
        transform-origin: center; /* Prevent scaling from affecting the layout */
    }

    /* Add a glow effect while hovering */
    .run-model-btn::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,99,71,0.6) 10%, transparent 60%);
        transition: opacity 0.3s;
        opacity: 0;
        z-index: 0;
    }

    .run-model-btn:hover::before {
        opacity: 1;
    }

    /* Click (active) effect */
    .run-model-btn:active {
        background-color: #e74c3c; /* Darker red on click */
        border-color: #ff6347; /* Border remains red */
        box-shadow: inset 0px 4px 8px rgba(0, 0, 0, 0.4), 0px 0px 20px rgba(255, 99, 71, 0.8); /* Inner shadow + glow */
        transform: scale(0.95); /* Slightly reduce size on click */
        animation: shake 0.3s ease-in-out; /* Add a slight shake on click */
        transform-origin: center; /* Ensure scaling doesn't break the layout */
    }

    .model-dropdown-container {
        position: relative; /* Child .model-dropdown-menu will be absolutely positioned here */
        display: inline-block;
    }

    .model-dropdown {
        position: relative; /* So the .dropdown-menu can position relative to this */
        margin-left: 5px; /* Space between the label and dropdown */
        border: 1px solid #067794;
        background-color: #505050;
        color: white;
        padding: 5px;
        cursor: pointer;
        border-radius: 10px; /* Rounded corners, adjust radius as needed */
        font-size: 16px;
        font-weight: bold;
        transition: transform 0.3s ease; /* Smooth transition for transform */
        text-align: center; /* Centers the text inside the dropdown */
        width: 60px; /* Width is being adjusted in the JavaScript */
        z-index: 11; /* Ensure it sits on top of other content */
    }
    
    .model-dropdown:hover {
        transform: scale(1.1); /* Slightly enlarge the button on hover */
        background-color: #ffffff;
        color: rgb(8, 8, 8);
        font-size: 18px;
        font-weight: bold;
        box-sizing: border-box;
    }

    .model-dropdown:active {
        transform: scale(0.9); /* Slightly reduce the size on click */
        background-color: #ffffff; /* Change to a different color on click */
        font-size: 20px; /* Increase font size for visibility */
        font-weight: bold;
    }

    .model-dropdown-menu {
        display: none; /* Initially hidden */
        position: absolute;
        top: calc(100% + 0px); /* Align top of menu just below the bottom of dropdown */
        left: 8px;
        /* transform: translateX(-50%); */
        width: 200px; /* Set the width to match the dropdown button */
        background-color: #93ad62;
        border-radius: 10px;
        box-shadow: 0px 8px 16px 0px rgba(255,0,0,1);
        z-index: 150; /* Ensure it sits on top of other content */
        transition: transform 0.3s ease;
    }

    .model-dropdown-details {
        display: none;
        position: absolute;
        top: 50%;
        left: 105%; /* Ensures the details appear to the right of the dropdown */
        transform: translateY(-50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px;
        border-radius: 5px;
        font-size: 14px;
        white-space: nowrap;
        z-index: 150;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
    }

    /* Show details message when hovering */
    .model-dropdown-item:hover .model-dropdown-details {
        display: block;
    }

    .model-dropdown-item {
        position: relative; /* Ensure the detail box is positioned correctly */
        padding: 12px 16px;
        text-decoration: none;
        display: flex; /* Make dropdown-item a flex container */
        align-items: center; /* Center content vertically */
        justify-content: center; /* Center content horizontally */
        color: white;
        cursor: pointer;
        font-size: 16px;
    }

    .model-dropdown-item:hover {
        /* transform: scale(1.25); Slightly enlarge the button on hover */
        background-color: #86d9e4;
        color: rgb(13, 13, 14);
        font-size: 18px;
        font-weight: bold;
        border-radius: 8px;
        /* border: 1px solid #ff3300; */
        /* padding: 0px; */
        transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .model-dropdown-item:active {
        transform: scale(0.9); /* Slightly reduce the size on click */
    }

    /* Additional remark field style */
    #showRemarkLabel.remark-toggle {
        display: none;
        align-items: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        background-color: #067794;
        padding: 5px 10px;
        border-radius: 8px;
        margin-left: 8px;
        transition: background-color 0.3s, transform 0.2s;
    }
    #showRemarkLabel.remark-toggle:hover {
        background-color: #0a9fc0;
        transform: scale(1.05);
        z-index: 16;
    }
    #showRemarkLabel.remark-toggle input {
        margin-right: 5px;
        width: 14px;
        height: 14px;
        cursor: pointer;
    }

    .remark-field {
        position: absolute;
        top: 38px; /* below the model selection bar */
        left: 3px;
        display: none;
        align-items: center;
        background-color: rgba(50, 50, 50, 0.9);
        color: #ffffff;
        border: 1px solid #067794;
        border-radius: 12px;
        padding: 10px 15px;
        font-size: 14px;
        font-weight: bold;
        z-index: 9;
        /* white-space: nowrap; */
        white-space: normal; /* ADD this line to allow wrapping */
        max-width: 650px;  /* max-width so that it doesn't get too wide */
        box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s ease-in-out, transform 0.2s ease-in-out;
        opacity: 0;
        transform: translateY(-10px);
        /* Add overflow-wrap just in case of very long unbroken strings */
        overflow-wrap: break-word;
    }
    .remark-field.show {
        display: flex;
        opacity: 1;
        transform: translateY(0);
    }

    .model-add-btn {
        /* Padding, alignment, font, etc. stay similar */
        padding: 12px 16px;
        text-align: center;
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
        color: #ffffff;
        border-top: 2px solid #067794;
        border-radius: 12px;            /* nice rounded corners */
        /* Subtle gradient from dark gray to a slightly lighter gray */
        background: linear-gradient(135deg, #505050 0%, #606060 100%);
        /* Drop shadow for a 3D “button” look */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    /* Hover effect: lighten the gradient, reduce shadow, maybe shift color a bit */
    .model-add-btn:hover {
        background: linear-gradient(
            135deg,
            #86d9e4 0%, 
            #70c7d2 100%
        );
        color: #000;
        transition: 0.2s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }

    /* Active (click) effect: “press in” look */
    .model-add-btn:active {
        transform: scale(0.95);
        background: linear-gradient(
            135deg,
            #cccccc 0%, 
            #aaaaaa 100%
        );
        box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    .upload-modal {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .upload-content {
        background-color: #333;
        padding: 20px 30px;
        border-radius: 12px;
        color: white;
        width: 400px;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .upload-content input,
    .upload-content textarea,
    .modal-actions button {
        box-sizing: border-box; /* Ensures padding/border are included in width */
    }

    .upload-content h3 {
        margin-top: 0;
        text-align: center;
    }

    .upload-content input,
    .upload-content textarea {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #555; /* You might want to change this border color too, e.g. (light to medium gray: #ccc, darker gray: #555) */
        border-radius: 6px;
        font-size: 14px;
        background-color: #444;
        color: white;
    }
    .upload-content input::placeholder,
    .upload-content textarea::placeholder {
        color: #aaa; /* Lighter placeholder text */
    }

    .upload-content textarea {
        resize: vertical;
        height: 80px;
    }

    .upload-content label {
        margin-top: 10px; /* Adds space above each label */
        display: block; /* Ensures label takes its own line */
        font-weight: bold; /* Make labels bold */
    }

    /* Prevent extra space above the very first label after the heading */
    .upload-content h3 + label {
        margin-top: 0;
    }

    .modal-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }
    .modal-actions button {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s; /* Add transitions */
    }
    .modal-actions button[type="submit"] {
        background-color: #4CAF50;
        color: white;
    }
    .modal-actions button[type="submit"]:hover {
        background-color: #45a049; /* Darker green */
    }
    .modal-actions button[type="button"] {
        background-color: #f44336;
        color: white;
    }
    .modal-actions button[type="button"]:hover {
        background-color: #da190b; /* Darker red */
    }
    .modal-actions button:active {
        transform: scale(0.95); /* Press effect */
    }
</style>

<div class="model-selection" id="leadDropdown"> 
    <!-- New container around the button + menu -->
    <div class="model-dropdown-container">
        <div class="model-dropdown"></div>
        <div class="model-dropdown-menu"></div>
    </div>
    <!-- The Show Details checkbox -->
    <label id="showRemarkLabel" class="remark-toggle">
        <input type="checkbox" id="toggleRemarkVisibility" />
        <span>Show Details</span>
    </label>
    <!-- Auto-label button -->
    <div class="run-model-btn">Auto-label</div>
</div>
<!-- Hidden field for the model remark -->
<div class="remark-field" id="modelRemarkField"></div>
<!-- Managing upload of a new trained model and its informations -->
<div id="modelUploadModal" style="display:none;" class="upload-modal">
    <div class="upload-content">
        <h3>Upload New Pretrained Model Weights</h3>
        <!-- Add novalidate to prevent default browser validation bubbles,
             as we'll handle validation feedback with alerts -->
        <form id="uploadModelForm" novalidate>
            <label for="inputModelName">Model Name:</label>
            <input type="text" id="inputModelName" required
                   pattern="[a-zA-Z0-9 ]+"
                   maxlength="30"
                   placeholder="Letters, numbers & spaces only. Max 30 characters."
                   title="Model name can only contain letters, numbers, and spaces (max 30 characters)." />
            <label for="inputModelFile">Model Weight (.pth):</label>
            <input type="file" id="inputModelFile" accept=".pth" required
                   title="Please select a model weight file ending with .pth" />
            <label for="inputModelRemarks">Remarks:</label>
            <textarea id="inputModelRemarks" maxlength="300" required
                      placeholder="Max 300 characters"
                      title="Enter remarks or details about the model (max 300 characters)." ></textarea>
            <label for="inputModelShortDesc">Short Description:</label>
            <input type="text" id="inputModelShortDesc" maxlength="30" required
                   placeholder="Max 30 characters"
                   title="Enter a brief description (max 30 characters)." />
            <div class="modal-actions">
                <button type="submit">Upload</button>
                <button type="button" id="cancelUpload">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modelDropdown        = document.querySelector('.model-dropdown');
        const modelDropdownMenu    = document.querySelector('.model-dropdown-menu');
        const autolabel            = document.querySelector('.run-model-btn');
        const remarkField          = document.getElementById('modelRemarkField');
        const toggleRemarkVisibility = document.getElementById('toggleRemarkVisibility');
        const showRemarkLabel      = document.getElementById('showRemarkLabel');
        const uploadForm = document.getElementById('uploadModelForm');
        const modelUploadModal = document.getElementById('modelUploadModal');
        const cancelUploadButton = document.getElementById('cancelUpload');
        const submitUploadButton = uploadForm.querySelector('button[type="submit"]');
        // Store original dropdown styles for easy updates in the future
        const originalDropdownStyles = {
            backgroundColor: getComputedStyle(modelDropdown).backgroundColor,
            color: getComputedStyle(modelDropdown).color,
            boxShadow: 'none'
        };

        let selectedModel = null; // To store the currently selected model

        // uploadForm.reset(); // Always clear on initialization. (In case status was error the last time you closed the app.)

        // Function to reset the dropdown text and styling
        function resetModelDropdown(show = false) {
            modelDropdown.textContent = 'Choose a Model ▼';
            // modelDropdown.style.textAlign = 'center'; // Ensure text is centered
            modelDropdown.style.width = `${modelDropdown.textContent.length * 10 + 10}px`; // Adjust width dynamically
            // Show or hide based on the parameter
            modelDropdown.style.display = show ? 'block' : 'none';
            if (show) {
                // Highlight effect to grab attention
                modelDropdown.style.backgroundColor = '#ffcc00'; // Bright yellow background
                modelDropdown.style.color = '#000000'; // Black text for contrast
                modelDropdown.style.boxShadow = '0px 0px 10px 3px rgba(255, 204, 0, 0.8)'; // Glow effect
                // Gradually revert back to normal after 1.5 seconds
                setTimeout(() => {
                    modelDropdown.style.backgroundColor = originalDropdownStyles.backgroundColor;
                    modelDropdown.style.color = originalDropdownStyles.color;
                    modelDropdown.style.boxShadow = originalDropdownStyles.boxShadow;
                }, 1500);
            }
        }

        autolabel.style.display = 'none'; // Hide the autolabel button at initialization
        showRemarkLabel.style.display = 'none'; // Hide the checkbox at initialization

        // Set dropdown to default text at initialization
        resetModelDropdown(false); // Keep it hidden at initialization

        modelDropdown.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent clicks from propagating
            // Toggle the display based on its current state
            // menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
            modelDropdownMenu.style.display = modelDropdownMenu.style.display === 'block' ? 'none' : 'block';
        });
        // Hide the menu when clicking outside it
        document.addEventListener('click', function() {
            modelDropdownMenu.style.display = 'none';
        });

        // Populate the menu when 'modelsReceived' event is dispatched
        document.addEventListener('modelsAVAILABLE', function(event) {
            remarkField.textContent = '';
            remarkField.classList.remove('show');
            remarkField.style.display = 'none'; // Hide & clear the model remark field
            toggleRemarkVisibility.checked = false; // Uncheck the "Show" checkbox too (so we start from a clean slate)
            autolabel.style.display = 'none'; // Hide the autolabel button when a new file is selected and new available models are received
            showRemarkLabel.style.display = 'none'; // Hide the checkbox
            const models = event.detail.models;
            populateModelDropdown(models, modelDropdownMenu);
            // Reset the dropdown when new models are received
            resetModelDropdown(true);
        });

        // Add a click listener to the Auto-label button
        autolabel.addEventListener('click', function() {
            if (selectedModel) {
                document.dispatchEvent(new CustomEvent('modelSelected', {detail: { model: selectedModel}}));
                console.log('---> Auto-label button clicked:', selectedModel);
            } else {
                console.error('No model selected!');
            }
        });

        // Listen for remarkofmodel here too, to display the remark in the new field
        //    Visibility depends on the checkbox's state
        document.addEventListener('remarkofmodel', function(event) {
            const { remark } = event.detail;
            remarkField.textContent = remark || '';

            // The remark field only appears if "Show" is checked and we have content
            if (toggleRemarkVisibility.checked && remark) {
                remarkField.style.display = 'flex';
                remarkField.classList.add('show'); // Apply the animation
            } else {
                // remarkField.style.display = 'none';
                remarkField.classList.remove('show');
                setTimeout(() => {
                    remarkField.style.display = 'none'; // Hide it properly after animation
                }, 300); // Wait for transition to complete before hiding

            }
        });

        // Checkbox change => show/hide remark
        toggleRemarkVisibility.addEventListener('change', function() {
            if (this.checked && remarkField.textContent.trim() !== '') {
                remarkField.style.display = 'flex';
                remarkField.classList.add('show');
            } else {
                remarkField.classList.remove('show');
                setTimeout(() => {
                    remarkField.style.display = 'none';
                }, 300);
            }
        });

        function populateModelDropdown(models, menu) {
            menu.innerHTML = ''; // Clear existing items
            for (const [modelName, modelDetails] of Object.entries(models)) {
                const item = document.createElement('div');
                item.textContent = modelName;
                item.classList.add('model-dropdown-item');
                // Create a details div
                const details = document.createElement('div');
                details.classList.add('model-dropdown-details');
                details.textContent = modelDetails.ShortDescription || "No short description";
                // Ensure positioning is correct
                item.style.position = 'relative';
                details.style.position = 'absolute';
                // Add hover event listeners (to ensure details show properly)
                item.appendChild(details);
                item.addEventListener('mouseenter', function () {
                    details.style.display = 'block';
                });
                item.addEventListener('mouseleave', function () {
                    details.style.display = 'none';
                });
                // Add click functionality for selecting the model
                item.onclick = function(event) {
                    event.stopPropagation(); // Prevent this click from closing the menu
                    selectModel(modelName, modelDetails.Remarks); // Pass model name and remark
                    modelDropdownMenu.style.display = 'none'; // Hide the menu after selection
                };
                modelDropdownMenu.appendChild(item);
            };
            // Now add the "+" button below all items
            const addBtn = document.createElement('div');
            addBtn.classList.add('model-add-btn');
            addBtn.textContent = '+';

            // Optional: handle click on the plus
            addBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                console.log("User clicked the + button");
                // // Explicitly close the model dropdown menu itself 
                modelDropdownMenu.style.display = 'none';
                // Show the modal
                modelUploadModal.style.display = 'flex';
            });
            modelDropdownMenu.appendChild(addBtn);
        }

        // selectModel => reveal auto-label & "Show" checkbox, dispatch remarkofmodel, etc.
        function selectModel(modelName, remark) {
            console.log('Selected model:', modelName, 'Remark:', remark);
            selectedModel = modelName; // Save the selected model
            // Update displayed text
            modelDropdown.textContent = modelName + ' ▼'; 
            // Centering logic based on text content
            modelDropdown.style.textAlign = 'center'; // Ensure text is centered
            modelDropdown.style.width = `${modelName.length * 10 + 10}px`; // Adjust width dynamically
            // Show the autolabel button and checkbox when a model is selected
            autolabel.style.display = 'block'; // Show the autolabel button when a model is selected
            showRemarkLabel.style.display = 'flex'; // Show the checkbox
            // Default the checkbox to checked => remark is shown
            toggleRemarkVisibility.checked = true;
            // Dispatch the event
            document.dispatchEvent(new CustomEvent('remarkofmodel', {detail: { remark: remark }}));
        }

        // --- Helper function to get CSRF token from cookies ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken'); // Get the token once on load

        cancelUploadButton.addEventListener('click', function() {
            uploadForm.reset();
            modelUploadModal.style.display = 'none';
        });

        uploadForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const modelNameInput = document.getElementById('inputModelName');
            const modelFileInput = document.getElementById('inputModelFile');
            const remarksInput = document.getElementById('inputModelRemarks');
            const shortDescInput = document.getElementById('inputModelShortDesc');

            const modelName = modelNameInput.value.trim();
            const modelFile = modelFileInput.files[0]; // Get the File object
            const remarks = remarksInput.value.trim();
            const shortDesc = shortDescInput.value.trim();
            
            // Check if all fields are filled (file needs special check)
            if (!modelName || !modelFile || !remarks || !shortDesc) {
                alert('Please fill all fields and select a model file.');
                return;
            }
            // Validate Model Name (letters and numbers only)
            const modelNameRegex = /^[a-zA-Z0-9 ]+$/;
            if (!modelNameRegex.test(modelName)) {
                alert('Invalid Model Name: Please use only letters (a-z, A-Z), numbers (0-9), and spaces.');
                modelNameInput.focus(); // Optional: focus the field
                return; 
            }
            // ADDED: Validate Model Name Length (max 30 characters)
            const MAX_MODEL_NAME_LENGTH = 30; // If you change this, you will need to track and update everywhere, including on the backend.
            if (modelName.length > MAX_MODEL_NAME_LENGTH) {
                alert(`Model Name is too (max ${MAX_MODEL_NAME_LENGTH} characters).`);
                modelNameInput.focus();
                return; // Stop processing
            }
            // Validate Model File (must end with .pth)
            const modelFileName = modelFile.name;
            if (!modelFileName.toLowerCase().endsWith('.pth')) {
                alert('Invalid Model Weight File: Please upload a file ending with .pth');
                modelFileInput.focus(); // Optional: focus the field
                // Clear the invalid file selection
                modelFileInput.value = ''; // Reset file input
                return; 
            }
            // Validate Short Description Length (max 30) - Redundant if maxlength="30" works, but safe check
            if (shortDesc.length > 30) {
                // This case should ideally not happen due to maxlength, but good belt-and-suspenders
                alert('Short Description is too long (max 30 characters).');
                shortDescInput.focus();
                return;
            }
            // Remarks Length (max 300) - Also redundant due to maxlength
            if (remarks.length > 300) {
                alert('Remarks are too long (max 300 characters).');
                remarksInput.focus();
                return;
            }
            console.log("Validation passed. Preparing model data...");

            // --- Prepare FormData for HTTP Request ---
            const formData = new FormData();
            formData.append('model_name', modelName);
            formData.append('remarks', remarks);
            formData.append('short_description', shortDesc);
            formData.append('model_file', modelFile, modelFile.name); // Key 'model_file' must match Django view
            // --- Disable button and provide feedback --- 
            submitUploadButton.disabled = true;
            submitUploadButton.textContent = 'Uploading...'; // Optional: Change button text
            console.log("Uploading model...");

            // --- Send data using Fetch API ---
            fetch('/upload-model/', { // <<<=== DJANGO UPLOAD URL HERE
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken // Include CSRF token // 'Content-Type' is NOT needed; browser sets it for FormData
                },
                body: formData
            })
            .then(response => {
                // Check if the response status is OK (2xx)
                if (response.ok) {
                    // If OK, parse the JSON body and pass it to the next .then()
                    return response.json(); // This promise resolves with the success data
                } else {
                    // If not OK (4xx, 5xx), read the response body as text first.
                    // This is safer as the error response might not be valid JSON.
                    return response.text().then(text => {
                        // We have the error response text. Now try to parse it.
                        let errorMessage = `Request failed with status: ${response.status}`; // Default message
                        try {
                            const errData = JSON.parse(text);
                            // If parsing succeeds and there's a message property, use it.
                            if (errData && errData.message) {
                                errorMessage = errData.message;
                            }
                        } catch (e) {
                            // Parsing failed, response body was not valid JSON.
                            // We'll stick with the default status-based message.
                            console.warn("Could not parse error response body as JSON. Body was:", text);
                        }
                        // IMPORTANT: Throw an error here. This ensures the promise chain
                        // transitions to the final .catch() block, passing along the
                        // determined error message.
                        throw new Error(errorMessage);
                    });
                }
            })
            .then(data => {
                // --- SUCCESS ---
                // This block only executes if response.ok was true and response.json() succeeded.
                console.log('Success:', data);
                alert(data.message || 'Model uploaded successfully!');
                document.dispatchEvent(new CustomEvent('modelUploadSuccessful', { detail: { name: modelName } })); // Use modelName from closure
                uploadForm.reset();
                modelUploadModal.style.display = 'none';
            })
            .catch(error => {
                // --- FAILURE ---
                // This catches errors from:
                // - Network issues (fetch couldn't reach server)
                // - Errors explicitly thrown in the .then() blocks above (e.g., from the non-OK handling)
                console.error('Upload Error:', error);
                // Display the message from the Error object that was thrown
                alert(`Upload failed: ${error.message}`);
            })
            .finally(() => {
                // --- ALWAYS RUNS ---
                // Re-enable button and reset text
                submitUploadButton.disabled = false;
                submitUploadButton.textContent = 'Upload';
                console.log("Upload attempt finished.");
            });
        });
    });
</script>
