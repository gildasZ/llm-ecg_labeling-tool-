
<!-- partials/Bodypart/_bodypart_ECGgraph.html -->
{% load static %} <!-- Make sure to load the static files -->
{% load plotly_dash %}    
{% plotly_message_pipe %}

<style>
    .graph_display-area {
        position: relative; /* Establishes a new positioning context */
        height: 100%;
        width: 100%; 
        background-color: #2976c4;
        display: flex;
        overflow: hidden; /* Prevents internal content from overflowing */
        z-index: 2;
    }

    .graph-container {
        /* flex-grow: 1; Takes available space */
        width: 100%;
        height: 100%;
        /* max-height: 100%;  Ensures it does not expand vertically beyond its parent */
        /* display: block; Block display to fill the area */
        overflow: hidden; /* Prevents internal content from overflowing */
        color: rgb(214, 61, 61); 
        font-size: 16px;
        background-color: #27293d; /* #353434 (light dark) or #bac429 (Light yellow) or #00008B (Dark blue)*/
        /* padding: 0; */
        align-items: center;
        justify-content: center; 
    }

    /* Modal (background) */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000; /* Ensure the modal is on top */
        left: 50%;
        top: 50%;
        width: 100%;
        height: 100%;
        transform: translate(-50%, -50%);
        overflow: auto;
        background-color: rgba(0,0,0,0.4); /* Semi-transparent background */
    }

    /* Modal Content */
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 500px;
        height: auto; /* 100px; */
        font-size: 28px;
        border-radius: 10px; 
        overflow: auto;
    }

    /* The Close Button */
    .close {
        color: #aaa;
        float: right;
        font-size: 32px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    /* Modal Header */
    .modal-header {
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
    }

    /* Modal Body */
    .modal-body {
        font-size: 18px;
        text-align: left;
        color: #0f0f0f;
    }
</style>

<div class="graph_display-area">
    <div class="graph-container">
        
        {% block content %}
            {% plotly_app name='Display_ECG_Graph' ratio=0.30 %} 
        {% endblock %}
    </div>
    <!-- Include the dropdown partial -->
    {% include 'partials/Bodypart/_bodypart_dropdown.html' %}
</div>

<!-- Custom Modal HTML -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalHeader" class="modal-header"></div>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>

<script>
    // Get the modal
    var modal = document.getElementById("myModal");
    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];
    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }
    // To close the modal if user clicks anywhere outside of it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Function to show the custom modal
    function showAlert(status, message) {
        console.log("Function showAlert executed.");
        var modalHeader = document.getElementById("modalHeader");
        var modalBody = document.getElementById("modalBody");

        if (status === true) {
            modalHeader.innerHTML = "Complete";
            modalHeader.style.color = "green"; // Set the color for "Complete"
            console.log("Complete alert executed.");
        } else {
            modalHeader.innerHTML = "Warning";
            modalHeader.style.color = "red"; // Set the color for "Warning"
            console.log("Warning alert executed.");
        }
        modalBody.innerHTML = message; // Display the message in the modal body
        modal.style.display = "block";
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Pick the right WS protocol based on the page's protocol
        const wsProto = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const socketUrl = wsProto + window.location.host + '/ws/process-xml/';
        const socket = new WebSocket(socketUrl); // Establish WebSocket connection

        let relativeFilePath = null; // Variable to hold the full path until the channel is selected

        socket.onopen = function() {
            console.log("WebSocket connection established:", socketUrl);
            // Now you can send messages
        };

        socket.onerror = function(error) {
            console.log("WebSocket error:", error);
        };

        socket.onclose = function() {
            console.log("WebSocket connection closed.");
        };
        
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("@@@@Received Parsed data from Django:", data);  // Log parsed data to verify structure and content
            
            if (data.type === 'existing_models') {
                console.log("***Client received ECG data from Django:", data); // Debugging: log received data
                // Dispatch the event with data for other components to use
                document.dispatchEvent(new CustomEvent('modelsAVAILABLE', { detail: data }));
            } else if (data.type === 'DjangoDash_message') {
                console.log("***Client received DjangoDash_message data from Django:", data); // Debugging: log received data
                // Log the annotation, click indices and item number separately
                console.log(
                    `Annotation message: ${data.Annotation_message}\n` + // Make sure you are using backticks (`) here!
                    `\tClick indices: ${data.Click_indices}\n` + 
                    `\tItem number: ${data.Item_number}\n` + 
                    `\tColor: ${data.Color}` 
                ); 
                // Dispatch the event with data for other components to use
                document.dispatchEvent(new CustomEvent('DjangoDash_message', { detail: data }));
            } else if (data.type === 'DjangoDash_retrieved_data_message') {
                console.log("***Client received DjangoDash_retrieved_data_message data from Django:", data); // Debugging: log received data
                // Log the retrieved data
                console.log("Existing_Data:", data.Existing_Data);
                // Dispatch the event with data for other components to use
                document.dispatchEvent(new CustomEvent('DjangoDash_retrieved_data_message', { detail: data }));
            } else if (data.type === 'Save_Feedback') {
                var message = data.Message;
                var status = data.Status;
                console.log("***Client received Save_Feedback data from Django:", data); // Debugging: log received data
                // Log the feedback message and status
                console.log("Save_Feedback message received:", message);
                console.log("Save_Feedback status received:", status);
                // Pop up window handling
                showAlert(status, message);
            } else if (data.type === 'user_data') {
                var user_name = data.User_name;
                var user_id = data.User_id;
                console.log("***Client received User data from Django:", data); // Debugging: log received data
                // Log teh user name and ID
                console.log("User_namee received:", user_name);
                console.log("User_id received:", user_id);
                // Dispatch the event with data for other components to use
                document.dispatchEvent(new CustomEvent('Receive_data', { detail: data }));
            } else if (data.type === 'DjangoDash_labels_status') {
                console.log("***Client received 'labels_display' data from Django:", data);
                // Dispatch the event with data 
                document.dispatchEvent(new CustomEvent('labels_display', { detail: data }));
            } 
        }

        document.addEventListener('fileSelected', function(event) {
            if (relativeFilePath !== event.detail.filePath) {
                relativeFilePath = event.detail.filePath; // Store (Update) the full path
                // Prepare the data to send with WebSocket
                var postData = {
                    type: 'processCSV_getMODELS', // Specific type for this combined data
                    RelativefilePath: relativeFilePath
                };
                // Send the data to the server via WebSocket
                socket.send(JSON.stringify(postData));
                console.log("Client sent the 'full file path' to Django for processing:", relativeFilePath); // Debugging: log file path being sent
            } else {
                console.log(
                    "The 'full file path' didn't change, so nothing was sent to Django for processing:\n" + // Make sure you are using backticks (`) here!
                    `\tprevious path: ${relativeFilePath}\n` + 
                    `\tcurrent path click: ${event.detail.filePath}` 
                ); 
            }
        });

        document.addEventListener('modelSelected', function(event) {
            var selectedModel = event.detail.model;
            // Prepare the data to send with WebSocket
            var postData = {
                type: 'DashDisplayWithAutoLabel', // Specific type for this combined data
                RelativefilePath: relativeFilePath,
                model: selectedModel
            };
            // Send the data to the server via WebSocket
            socket.send(JSON.stringify(postData));
            console.log("Client sent the 'full file path' and the 'selected model' to Django:"); // Debugging: log received data or event.data?
            console.log(relativeFilePath);
            console.log(selectedModel);
        });

        document.addEventListener('buttonClick', function(event) {
            var action_var = event.detail.action;
            // Check if event.detail.data exists, if not, assign an empty list
            var data_var = event.detail.data || [];
            console.log("   'buttonClick' event received:", action_var, data_var);
            // Prepare the data to send with WebSocket
            var postData = {
                type: 'Refresh_Save_Undo_Delete', // Specific type for this combined data
                Action_var: action_var,
                Data_var: data_var // Include the new Data_var for deletion
            };
            // Send the data to the server via WebSocket
            socket.send(JSON.stringify(postData));
            console.log("   Client sent the 'Refresh or Save or Undo or Save All' action to Django for processing,      action:", action_var);
        });

        document.addEventListener('labels_display_update', function(event) {
            var labels_updated = event.detail;
            console.log("***Updated 'labels_display' data received:", labels_updated);
            // Prepare the data to send with WebSocket
            var postData = {
                type: 'labels_display_updated', // Specific type for this combined data
                updated_labels_status: labels_updated
            };
            // Send the data to the server via WebSocket
            socket.send(JSON.stringify(postData));
            console.log("   Client sent the 'labels_display_updated' data to Django for processing,      data:", postData);
        });
    });
</script>
